<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>å ±å‘Šè³‡æ–™åº«æŸ¥è©¢</title>
    <style>
        :root{
            --bg:#f7f8fa; --card:#ffffff; --text:#1f2937; --muted:#6b7280;
            --pri:#2563eb; --pri-100:#dbeafe; --ring:#93c5fd; --ok:#16a34a; --err:#dc2626;
            --border:#e5e7eb;
        }
        *{box-sizing:border-box}
        body{
            margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans TC",sans-serif;
            color:var(--text); background:linear-gradient(180deg,#f8fafc,#eef2f7 40%,#eef2f7);
        }
        .container{max-width:980px;margin:40px auto;padding:0 16px}
        .card{
            background:var(--card); border:1px solid var(--border); border-radius:16px;
            box-shadow:0 8px 24px rgba(0,0,0,.06); overflow:hidden;
        }
        .header{
            padding:20px 24px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:12px;
        }
        .logo{
            width:36px;height:36px;display:grid;place-items:center;border-radius:10px;background:var(--pri-100);color:var(--pri);font-weight:700;
        }
        h1{font-size:18px; margin:0}
        .muted{color:var(--muted); font-size:13px}
        .content{padding:20px 24px}
        .row{display:grid;grid-template-columns:1fr 1fr 1fr; gap:16px}
        @media (max-width:768px){ .row{grid-template-columns:1fr} }
        .field{display:flex; flex-direction:column; gap:8px}
        label{font-size:14px; font-weight:600}
        input[type="text"], input[type="date"]{
            padding:12px 12px; border:1px solid var(--border); border-radius:10px; background:#fff; font-size:14px;
            outline:none; transition:border-color .15s, box-shadow .15s;
        }
        input:focus{
            border-color:var(--ring); box-shadow:0 0 0 4px rgba(147,197,253,.35);
        }
        .actions{display:flex; gap:12px; margin-top:10px; flex-wrap:wrap}
        button{
            border:0; border-radius:10px; padding:12px 16px; font-weight:700; cursor:pointer; font-size:14px;
            display:inline-flex; align-items:center; gap:8px;
        }
        .btn-primary{background:var(--pri); color:#fff}
        .btn-secondary{background:#fff; color:var(--text); border:1px solid var(--border)}
        .section-title{margin:18px 0 8px; font-size:14px; color:var(--muted); font-weight:700; text-transform:uppercase; letter-spacing:.06em}
        .result{border:1px solid var(--border); border-radius:12px; overflow:hidden; background:#fff; margin-top:14px}
        table{width:100%; border-collapse:collapse; font-size:14px}
        thead{background:#f8fafc}
        th, td{padding:12px 14px; border-bottom:1px solid var(--border); text-align:left; vertical-align:top}
        .empty{padding:16px; color:var(--muted)}
    </style>
</head>
<body>
<div class="container">
    <div class="card">
        <div class="header">
            <div class="logo">DB</div>
            <div>
                <h1>å ±å‘Šè³‡æ–™åº«æŸ¥è©¢</h1>
                <div class="muted">æ”¯æ´ç—…æ‚£è³‡è¨Šã€æ—¥æœŸç¯„åœèˆ‡é—œéµå­—æŸ¥è©¢ï¼Œé€£å‹• n8n Webhookã€‚</div>
            </div>
        </div>

        <div class="content">
            <!-- ç—…æ‚£è³‡è¨Šè¼¸å…¥ -->
            <div class="section-title">ç—…æ‚£è³‡è¨ŠæŸ¥è©¢</div>
            <div class="row">
                <div class="field">
                    <label for="patientInput">è¼¸å…¥</label>
                    <input type="text" id="patientInput" placeholder="å¯è¼¸å…¥ç—…ç—‡æè¿°é—œéµå­—" />
                </div>
                <div class="field">
                    <label for="patientName">ç—…æ‚£åç¨±</label>
                    <input type="text" id="patientName" placeholder="Patient Name" />
                </div>
                <div class="field">
                    <label for="patientInfo">ç—…æ‚£è³‡è¨Š</label>
                    <input type="text" id="patientInfo" placeholder="Patient Info" />
                </div>
            </div>

            <!-- æ—¥æœŸå€é–“ -->
            <div class="section-title">æ—¥æœŸç¯„åœæŸ¥è©¢</div>
            <div class="row">
                <div class="field">
                    <label for="dateFrom">é–‹å§‹æ—¥æœŸ</label>
                    <input type="date" id="dateFrom" />
                </div>
                <div class="field">
                    <label for="dateTo">çµæŸæ—¥æœŸ</label>
                    <input type="date" id="dateTo" />
                </div>
            </div>

            <div class="actions">
                <button class="btn-primary" id="btnSearch">ğŸ” æŸ¥è©¢</button>
                <button class="btn-secondary" id="btnReset">â†º é‡è¨­</button>
            </div>

            <div class="section-title">æŸ¥è©¢çµæœ</div>
            <div class="result" id="result">
                <div class="empty">å°šæœªæŸ¥è©¢ï¼Œè«‹å…ˆè¼¸å…¥æ¢ä»¶ä¸¦æŒ‰ã€ŒæŸ¥è©¢ã€ã€‚</div>
            </div>
        </div>
    </div>
</div>

<script>
    const QUERY_EP = "https://n8n.fcubiolab.com/webhook/query-reports"; // âš ï¸ æ”¹ç”¨æ­£å¼ webhook è·¯å¾‘
    const resultBox = document.getElementById('result');

    document.getElementById('btnSearch').addEventListener('click', async () => {
        const patientInput = document.getElementById('patientInput').value;
        const patientName = document.getElementById('patientName').value;
        const patientInfo = document.getElementById('patientInfo').value;
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;

        if (!patientInput && !patientName && !patientInfo && !dateFrom && !dateTo) {
            return showEmpty("è«‹è‡³å°‘è¼¸å…¥ä¸€å€‹æŸ¥è©¢æ¢ä»¶ã€‚");
        }

        const payload = { patientInput, patientName, patientInfo, dateFrom, dateTo };

        try {
            const resp = await fetch(QUERY_EP, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
            });

            const text = await resp.text();
            if (!resp.ok) throw new Error(`HTTP ${resp.status} ${text}`);

            let data = text ? JSON.parse(text) : [];
            let rows = Array.isArray(data) ? data : (data.items || data.data || []);
            if (rows.length && rows[0]?.json) rows = rows.map(x => x.json);

            if (!rows.length) return showEmpty('æœªæ‰¾åˆ°è³‡æ–™ã€‚');
            renderTable(rows);
        } catch (err) {
            console.error(err);
            showEmpty("æŸ¥è©¢å¤±æ•—ï¼š" + err.message);
        }
    });

    document.getElementById('btnReset').addEventListener('click', () => {
        document.getElementById('patientInput').value = '';
        document.getElementById('patientName').value = '';
        document.getElementById('patientInfo').value = '';
        document.getElementById('dateFrom').value = '';
        document.getElementById('dateTo').value = '';
        resultBox.innerHTML = '<div class="empty">å°šæœªæŸ¥è©¢ï¼Œè«‹å…ˆè¼¸å…¥æ¢ä»¶ä¸¦æŒ‰ã€ŒæŸ¥è©¢ã€ã€‚</div>';
    });

    function showEmpty(msg){
        resultBox.innerHTML = `<div class="empty">${msg}</div>`;
    }

    function renderTable(items){
        const rows = items.map((it, idx) => `
        <tr>
          <td>${idx + 1}</td>
          <td>${it.input || ''}</td>
          <td>${it.patient_name || ''}</td>
          <td>${it.patient_info || ''}</td>
          <td>${(it.created_at || '').slice(0,10)}</td>
          <td>${it.tumor_location || ''}</td>
          <td>${it.tumor_size_cm || ''}</td>
          <td>${it.T_stage || ''}</td>
          <td>${it.N_stage || ''}</td>
          <td>${it.M_stage || ''}</td>
          <td>${it.lung_rads_category || ''}</td>
          <td>${it.other_findings || ''}</td>
          <td>${it.report_text || ''}</td>
        </tr>
      `).join('');

        resultBox.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>è¼¸å…¥</th>
              <th>ç—…æ‚£åç¨±</th>
              <th>ç—…æ‚£è³‡è¨Š</th>
              <th>æ—¥æœŸ</th>
              <th>è…«ç˜¤ä½ç½®</th>
              <th>è…«ç˜¤å¤§å°</th>
              <th>T åˆ†æœŸ</th>
              <th>N åˆ†æœŸ</th>
              <th>M åˆ†æœŸ</th>
              <th>Lung-RADS</th>
              <th>å…¶ä»–ç™¼ç¾</th>
              <th>å ±å‘Šå…§å®¹</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }
</script>
</body>
</html>
